<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .error {
            color: red;
            font-size: 14px;
        }
        .log-box {
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Enter your username"><br><br>
        <input type="password" id="password" placeholder="Enter your password"><br><br>
        <button onclick="login()">Login</button>
        <p id="error-message" class="error"></p>
    </div>

    <!-- Monitor Screen -->
    <div id="monitor-screen" class="hidden">
        <h1>Real-time Server Statistics</h1>
        <div id="stats">Loading...</div>
        <h3>System Uptime</h3>
        <div id="system-uptime">Loading...</div>
        <h3>Process Summary</h3>
        <div id="process-summary">Loading...</div>
        <h3>Process List</h3>
        <div id="process-list">Loading...</div>
        <h3>Current User</h3>
        <div id="current-user">No user logged in</div>
        <h3>Last 10 Users</h3>
        <div id="last-users">No users logged in yet</div>
        <h3>System Logs (Last 50 Lines)</h3>
        <div id="system-logs" class="log-box">Loading...</div>
    </div>

    <script>
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const errorMessage = document.getElementById("error-message");
        const loginScreen = document.getElementById("login-screen");
        const monitorScreen = document.getElementById("monitor-screen");
        const statsDiv = document.getElementById("stats");
        const processSummaryDiv = document.getElementById("process-summary");
        const processListDiv = document.getElementById("process-list");
        const currentUserDiv = document.getElementById("current-user");
        const lastUsersDiv = document.getElementById("last-users");
        const systemLogsDiv = document.getElementById("system-logs");
        const systemUptimeDiv = document.getElementById("system-uptime");

        const server_url = 'wss://' + location.host + location.pathname.replace('monitor', 'ws');
        const ws = new WebSocket(server_url);

        ws.onerror = (e) => {
            statsDiv.innerHTML = `<div style="color:red;">WebSocket Error: ${e.message}</div>`;
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message[0] === "auth_status") {
                if (message[1].status === "success") {
                    loginScreen.classList.add("hidden");
                    monitorScreen.classList.remove("hidden");
                } else {
                    errorMessage.innerText = "Invalid username or password!";
                }
            } else if (message[0] === "stats") {
                updateStats(message[1]);
                updateSystemUptime(message[1].uptime);
                updateProcessSummary(message[1].process_summary);
                updateProcessList(message[1].processes);
                updateSystemLogs(message[1].logs);
            } else if (message[0] === "last_users") {
                updateLastUsers(message[1]);
            } else if (message[0] === "current_user") {
                updateCurrentUser(message[1]);
            }
        };

        function login() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if (username && password) {
                ws.send(JSON.stringify({ action: "login", username, password }));
                errorMessage.innerText = "";
            } else {
                errorMessage.innerText = "Username and password cannot be empty!";
            }
        }

        function updateStats(stats) {
            statsDiv.innerHTML = `
                <div><strong>CPU Usage:</strong> ${stats.cpu}%</div>
                <div><strong>Memory Usage:</strong>
                    ${((stats.memory.used / stats.memory.total) * 100).toFixed(2)}%
                    (${(stats.memory.used / 1e9).toFixed(2)} GB / ${(stats.memory.total / 1e9).toFixed(2)} GB)
                </div>
                <div><strong>Disk Usage:</strong>
                    ${stats.disk.percent}% 
                    (${(stats.disk.used / 1e9).toFixed(2)} GB / ${(stats.disk.total / 1e9).toFixed(2)} GB)
                </div>
                <div><strong>Load Average:</strong>
                    1m: ${stats.load_avg[0].toFixed(1)}, 5m: ${stats.load_avg[1].toFixed(1)}, 15m: ${stats.load_avg[2].toFixed(1)}
                </div>
            `;
        }

        function updateSystemUptime(uptime) {
            systemUptimeDiv.innerText = uptime;
        }

        function updateProcessSummary(summary) {
            processSummaryDiv.innerHTML = `
                <div><strong>Total Processes:</strong> ${summary.total}</div>
                <div><strong>Running:</strong> ${summary.running}</div>
                <div><strong>Sleeping:</strong> ${summary.sleeping}</div>
                <div><strong>Stopped:</strong> ${summary.stopped}</div>
                <div><strong>Zombie:</strong> ${summary.zombie}</div>
            `;
        }

        function updateProcessList(processes) {
            processListDiv.innerHTML = processes.length > 0
                ? processes.map(proc => `<div>PID: ${proc.pid}, Name: ${proc.name}, CPU: ${proc.cpu_percent}%, Memory: ${proc.memory_percent}%</div>`).join('')
                : 'No processes available';
        }

        function updateSystemLogs(logs) {
            systemLogsDiv.innerHTML = logs.length > 0
                ? logs.map(log => `<div>${log}</div>`).join('')
                : 'No logs available';
        }

        function updateCurrentUser(username) {
            currentUserDiv.innerText = username || "No user logged in";
        }

        function updateLastUsers(users) {
            lastUsersDiv.innerHTML = users.length > 0
                ? users.map(user => `<div>${user}</div>`).join('')
                : 'No users logged in yet';
        }

        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: "stats" }));
            }
        }, 3000); // Request stats every 3 seconds
    </script>
</body>
</html>